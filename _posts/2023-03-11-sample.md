'''
layout :  sample jupyter notebook
title : Upload jupyter notebook markdown
'''

#### 공부할 때, 참고하면 좋은!
https://github.com/mnegypt/jupyter-notebooks/blob/master/IMarketBasket.ipynb

# 1) 환경설정


```python
# 연관성분석(추천)  패키지 다운로드 및 설치 
# !pip install mlxtend --upgrade
```


```python
## 1. 분석에 사용할 패키지 로딩
import numpy as np
import pandas as pd

import matplotlib.pyplot as plt 
import seaborn as sns

import datetime as dt # 날짜를 다루기 위한 패키지

from mlxtend.preprocessing import TransactionEncoder # 구매 데이터를 연관성 분석을 위한 메트릭스 형태로 변환
from mlxtend.frequent_patterns import apriori, association_rules, fpgrowth 
# fpgrowth 는 mlxtend version: 0.20.0 이상에서 지원
# apriori : 보편적이고 간단
# fpgrowth : 연관성 분석알고리즘 중 최신 알고리즘
```


```python
data = pd.read_csv('./data.csv', encoding = 'unicode_escape')
# unicode_escape : 유니코드 디코드 에러 자체를 무시하는 방법
```


```python
data.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>InvoiceNo</th>
      <th>StockCode</th>
      <th>Description</th>
      <th>Quantity</th>
      <th>InvoiceDate</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
      <th>Country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>536365</td>
      <td>85123A</td>
      <td>WHITE HANGING HEART T-LIGHT HOLDER</td>
      <td>6</td>
      <td>12/1/2010 8:26</td>
      <td>2.55</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>1</th>
      <td>536365</td>
      <td>71053</td>
      <td>WHITE METAL LANTERN</td>
      <td>6</td>
      <td>12/1/2010 8:26</td>
      <td>3.39</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>2</th>
      <td>536365</td>
      <td>84406B</td>
      <td>CREAM CUPID HEARTS COAT HANGER</td>
      <td>8</td>
      <td>12/1/2010 8:26</td>
      <td>2.75</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>3</th>
      <td>536365</td>
      <td>84029G</td>
      <td>KNITTED UNION FLAG HOT WATER BOTTLE</td>
      <td>6</td>
      <td>12/1/2010 8:26</td>
      <td>3.39</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>4</th>
      <td>536365</td>
      <td>84029E</td>
      <td>RED WOOLLY HOTTIE WHITE HEART.</td>
      <td>6</td>
      <td>12/1/2010 8:26</td>
      <td>3.39</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
  </tbody>
</table>
</div>




```python
data.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 541909 entries, 0 to 541908
    Data columns (total 8 columns):
     #   Column       Non-Null Count   Dtype  
    ---  ------       --------------   -----  
     0   InvoiceNo    541909 non-null  object 
     1   StockCode    541909 non-null  object 
     2   Description  540455 non-null  object 
     3   Quantity     541909 non-null  int64  
     4   InvoiceDate  541909 non-null  object 
     5   UnitPrice    541909 non-null  float64
     6   CustomerID   406829 non-null  float64
     7   Country      541909 non-null  object 
    dtypes: float64(2), int64(1), object(5)
    memory usage: 33.1+ MB
    


```python
data['InvoiceDate']
```




    0          12/1/2010 8:26
    1          12/1/2010 8:26
    2          12/1/2010 8:26
    3          12/1/2010 8:26
    4          12/1/2010 8:26
                   ...       
    541904    12/9/2011 12:50
    541905    12/9/2011 12:50
    541906    12/9/2011 12:50
    541907    12/9/2011 12:50
    541908    12/9/2011 12:50
    Name: InvoiceDate, Length: 541909, dtype: object




```python
data['InvoiceDate'] = pd.to_datetime(data['InvoiceDate'])
```


```python
data.head(2)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>InvoiceNo</th>
      <th>StockCode</th>
      <th>Description</th>
      <th>Quantity</th>
      <th>InvoiceDate</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
      <th>Country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>536365</td>
      <td>85123A</td>
      <td>WHITE HANGING HEART T-LIGHT HOLDER</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>2.55</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>1</th>
      <td>536365</td>
      <td>71053</td>
      <td>WHITE METAL LANTERN</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
  </tbody>
</table>
</div>




```python
data.isna().sum()
```




    InvoiceNo           0
    StockCode           0
    Description      1454
    Quantity            0
    InvoiceDate         0
    UnitPrice           0
    CustomerID     135080
    Country             0
    dtype: int64




```python
data.describe()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Quantity</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>541909.000000</td>
      <td>541909.000000</td>
      <td>406829.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>9.552250</td>
      <td>4.611114</td>
      <td>15287.690570</td>
    </tr>
    <tr>
      <th>std</th>
      <td>218.081158</td>
      <td>96.759853</td>
      <td>1713.600303</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-80995.000000</td>
      <td>-11062.060000</td>
      <td>12346.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>1.000000</td>
      <td>1.250000</td>
      <td>13953.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>3.000000</td>
      <td>2.080000</td>
      <td>15152.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>10.000000</td>
      <td>4.130000</td>
      <td>16791.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>80995.000000</td>
      <td>38970.000000</td>
      <td>18287.000000</td>
    </tr>
  </tbody>
</table>
</div>




```python
data[data.CustomerID.isna()].head(3)
# 연관성 분석에서는 고객id기준이 아닌, 영수증기준이므로, 고객id null값도 버리지 않을것!
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>InvoiceNo</th>
      <th>StockCode</th>
      <th>Description</th>
      <th>Quantity</th>
      <th>InvoiceDate</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
      <th>Country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>622</th>
      <td>536414</td>
      <td>22139</td>
      <td>NaN</td>
      <td>56</td>
      <td>2010-12-01 11:52:00</td>
      <td>0.00</td>
      <td>NaN</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>1443</th>
      <td>536544</td>
      <td>21773</td>
      <td>DECORATIVE ROSE BATHROOM BOTTLE</td>
      <td>1</td>
      <td>2010-12-01 14:32:00</td>
      <td>2.51</td>
      <td>NaN</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>1444</th>
      <td>536544</td>
      <td>21774</td>
      <td>DECORATIVE CATS BATHROOM BOTTLE</td>
      <td>2</td>
      <td>2010-12-01 14:32:00</td>
      <td>2.51</td>
      <td>NaN</td>
      <td>United Kingdom</td>
    </tr>
  </tbody>
</table>
</div>




```python
data[data.Description.isna()]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>InvoiceNo</th>
      <th>StockCode</th>
      <th>Description</th>
      <th>Quantity</th>
      <th>InvoiceDate</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
      <th>Country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>622</th>
      <td>536414</td>
      <td>22139</td>
      <td>NaN</td>
      <td>56</td>
      <td>2010-12-01 11:52:00</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>1970</th>
      <td>536545</td>
      <td>21134</td>
      <td>NaN</td>
      <td>1</td>
      <td>2010-12-01 14:32:00</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>1971</th>
      <td>536546</td>
      <td>22145</td>
      <td>NaN</td>
      <td>1</td>
      <td>2010-12-01 14:33:00</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>1972</th>
      <td>536547</td>
      <td>37509</td>
      <td>NaN</td>
      <td>1</td>
      <td>2010-12-01 14:33:00</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>1987</th>
      <td>536549</td>
      <td>85226A</td>
      <td>NaN</td>
      <td>1</td>
      <td>2010-12-01 14:34:00</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>535322</th>
      <td>581199</td>
      <td>84581</td>
      <td>NaN</td>
      <td>-2</td>
      <td>2011-12-07 18:26:00</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>535326</th>
      <td>581203</td>
      <td>23406</td>
      <td>NaN</td>
      <td>15</td>
      <td>2011-12-07 18:31:00</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>535332</th>
      <td>581209</td>
      <td>21620</td>
      <td>NaN</td>
      <td>6</td>
      <td>2011-12-07 18:35:00</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>536981</th>
      <td>581234</td>
      <td>72817</td>
      <td>NaN</td>
      <td>27</td>
      <td>2011-12-08 10:33:00</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>538554</th>
      <td>581408</td>
      <td>85175</td>
      <td>NaN</td>
      <td>20</td>
      <td>2011-12-08 14:06:00</td>
      <td>0.0</td>
      <td>NaN</td>
      <td>United Kingdom</td>
    </tr>
  </tbody>
</table>
<p>1454 rows × 8 columns</p>
</div>




```python
data[data.Description.isna()]['UnitPrice'].value_counts()
```




    0.0    1454
    Name: UnitPrice, dtype: int64



##### description이 결측인데 stockcode랑 mapping안되는게 있는지 확인!  
description이 null이어도 안버리고 가져가보려고!  
> 했으나,,다 unitprice 0원,,


```python
des_na_sc = data[data.Description.isna()]['StockCode'].unique().tolist()
```


```python
dic = pd.DataFrame(data.groupby('StockCode')['Description'].count()).reset_index()
```


```python
dic[(dic.StockCode.isin(des_na_sc))&dic['Description'].isna()]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>StockCode</th>
      <th>Description</th>
    </tr>
  </thead>
  <tbody>
  </tbody>
</table>
</div>



## 데이터 탐색 및 이상치 제거


```python
data.shape
```




    (541909, 8)




```python
# 1) UnitPrice = 0 제거
data1 = data[data.UnitPrice >0]
```


```python
data1.shape
```




    (539392, 8)




```python
data1.describe()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Quantity</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>539392.000000</td>
      <td>539392.000000</td>
      <td>406789.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>9.845904</td>
      <td>4.673648</td>
      <td>15287.795830</td>
    </tr>
    <tr>
      <th>std</th>
      <td>215.412652</td>
      <td>94.614722</td>
      <td>1713.573064</td>
    </tr>
    <tr>
      <th>min</th>
      <td>-80995.000000</td>
      <td>0.001000</td>
      <td>12346.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>1.000000</td>
      <td>1.250000</td>
      <td>13954.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>3.000000</td>
      <td>2.080000</td>
      <td>15152.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>10.000000</td>
      <td>4.130000</td>
      <td>16791.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>80995.000000</td>
      <td>38970.000000</td>
      <td>18287.000000</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 2) Quantity < 0 이면 환불건! 확인 후 제거
set([x[:1] for x in data1[data1.Quantity < 0]['InvoiceNo']])
```




    {'C'}




```python
data1 = data1[data1.Quantity >=0]
```


```python
data1.describe()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Quantity</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>530104.000000</td>
      <td>530104.000000</td>
      <td>397884.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>10.542037</td>
      <td>3.907625</td>
      <td>15294.423453</td>
    </tr>
    <tr>
      <th>std</th>
      <td>155.524124</td>
      <td>35.915681</td>
      <td>1713.141560</td>
    </tr>
    <tr>
      <th>min</th>
      <td>1.000000</td>
      <td>0.001000</td>
      <td>12346.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>1.000000</td>
      <td>1.250000</td>
      <td>13969.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>3.000000</td>
      <td>2.080000</td>
      <td>15159.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>10.000000</td>
      <td>4.130000</td>
      <td>16795.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>80995.000000</td>
      <td>13541.330000</td>
      <td>18287.000000</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 고객별 Quantity 이상치 확인
data1[data1.Quantity == 80995]
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>InvoiceNo</th>
      <th>StockCode</th>
      <th>Description</th>
      <th>Quantity</th>
      <th>InvoiceDate</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
      <th>Country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>540421</th>
      <td>581483</td>
      <td>23843</td>
      <td>PAPER CRAFT , LITTLE BIRDIE</td>
      <td>80995</td>
      <td>2011-12-09 09:15:00</td>
      <td>2.08</td>
      <td>16446.0</td>
      <td>United Kingdom</td>
    </tr>
  </tbody>
</table>
</div>




```python
np.percentile(data1.Quantity,75) + 1.5*(np.percentile(data1.Quantity,75)-np.percentile(data1.Quantity,25))
```




    23.5




```python
np.percentile(data1.Quantity,99)
```




    100.0




```python
fig, ax = plt.subplots()
ax.boxplot(data1['Quantity'])
ax.set_ylim (0,100)
```




    (0.0, 100.0)




![png](output_30_1.png)



```python
print(data1.Quantity.mean() + data1.Quantity.std(),data1.Quantity.mean() + data1.Quantity.std()*3)
```

    166.06616054487858 477.1144075661511
    


```python
data2 = data1[data1.Quantity <= 100].reset_index(drop=True)
```


```python
data2.describe()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Quantity</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>525255.000000</td>
      <td>525255.000000</td>
      <td>393225.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>7.936888</td>
      <td>3.930387</td>
      <td>15294.104904</td>
    </tr>
    <tr>
      <th>std</th>
      <td>12.558855</td>
      <td>36.080000</td>
      <td>1712.009054</td>
    </tr>
    <tr>
      <th>min</th>
      <td>1.000000</td>
      <td>0.001000</td>
      <td>12347.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>1.000000</td>
      <td>1.250000</td>
      <td>13969.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>3.000000</td>
      <td>2.100000</td>
      <td>15159.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>10.000000</td>
      <td>4.130000</td>
      <td>16794.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>100.000000</td>
      <td>13541.330000</td>
      <td>18287.000000</td>
    </tr>
  </tbody>
</table>
</div>



#### Invoiceno 기준으로 테이블 변경 후, 이상치 검증  
: data2 너무 건 적어져서 우선 data1으로


```python
data1.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>InvoiceNo</th>
      <th>StockCode</th>
      <th>Description</th>
      <th>Quantity</th>
      <th>InvoiceDate</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
      <th>Country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>536365</td>
      <td>85123A</td>
      <td>WHITE HANGING HEART T-LIGHT HOLDER</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>2.55</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>1</th>
      <td>536365</td>
      <td>71053</td>
      <td>WHITE METAL LANTERN</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>2</th>
      <td>536365</td>
      <td>84406B</td>
      <td>CREAM CUPID HEARTS COAT HANGER</td>
      <td>8</td>
      <td>2010-12-01 08:26:00</td>
      <td>2.75</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>3</th>
      <td>536365</td>
      <td>84029G</td>
      <td>KNITTED UNION FLAG HOT WATER BOTTLE</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>4</th>
      <td>536365</td>
      <td>84029E</td>
      <td>RED WOOLLY HOTTIE WHITE HEART.</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
  </tbody>
</table>
</div>




```python
data_invoice_cnt = pd.DataFrame(data1.groupby('InvoiceNo')['StockCode'].count()).reset_index()
```


```python
data_invoice_cnt.rename({'StockCode':'n'},axis = 1, inplace = True)
```


```python
data_invoice_cnt
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>InvoiceNo</th>
      <th>n</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>536365</td>
      <td>7</td>
    </tr>
    <tr>
      <th>1</th>
      <td>536366</td>
      <td>2</td>
    </tr>
    <tr>
      <th>2</th>
      <td>536367</td>
      <td>12</td>
    </tr>
    <tr>
      <th>3</th>
      <td>536368</td>
      <td>4</td>
    </tr>
    <tr>
      <th>4</th>
      <td>536369</td>
      <td>1</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>19955</th>
      <td>581584</td>
      <td>2</td>
    </tr>
    <tr>
      <th>19956</th>
      <td>581585</td>
      <td>21</td>
    </tr>
    <tr>
      <th>19957</th>
      <td>581586</td>
      <td>4</td>
    </tr>
    <tr>
      <th>19958</th>
      <td>581587</td>
      <td>15</td>
    </tr>
    <tr>
      <th>19959</th>
      <td>A563185</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
<p>19960 rows × 2 columns</p>
</div>




```python
data_invoice_cnt.describe()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>n</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>19542.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>26.878262</td>
    </tr>
    <tr>
      <th>std</th>
      <td>47.888395</td>
    </tr>
    <tr>
      <th>min</th>
      <td>1.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>7.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>16.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>29.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>1110.000000</td>
    </tr>
  </tbody>
</table>
</div>




```python
fig, ax = plt.subplots()
ax.boxplot(data_invoice_cnt['n'])
ax.set_ylim (0,100)
```




    (0.0, 100.0)




![png](output_40_1.png)



```python
data_invoice_cnt['n'].quantile(.99)
```




    219.40999999999985




```python
data_invoice_cnt['n'].quantile(.75) + 1.5*(data_invoice_cnt['n'].quantile(.75)-data_invoice_cnt['n'].quantile(.25))
```




    63.5




```python
print(data_invoice_cnt['n'].mean() + data_invoice_cnt['n'].std(), data_invoice_cnt['n'].mean() + data_invoice_cnt['n'].std()*3)
```

    74.10038236879666 169.18451383985692
    


```python
data_invoice_cnt.shape
```




    (19960, 2)




```python
outlier_treat = data_invoice_cnt[(data_invoice_cnt.n >= 2)  & (data_invoice_cnt.n <= 150)]
```


```python
data2.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>InvoiceNo</th>
      <th>StockCode</th>
      <th>Description</th>
      <th>Quantity</th>
      <th>InvoiceDate</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
      <th>Country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>536365</td>
      <td>85123A</td>
      <td>WHITE HANGING HEART T-LIGHT HOLDER</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>2.55</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>1</th>
      <td>536365</td>
      <td>71053</td>
      <td>WHITE METAL LANTERN</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>2</th>
      <td>536365</td>
      <td>84406B</td>
      <td>CREAM CUPID HEARTS COAT HANGER</td>
      <td>8</td>
      <td>2010-12-01 08:26:00</td>
      <td>2.75</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>3</th>
      <td>536365</td>
      <td>84029G</td>
      <td>KNITTED UNION FLAG HOT WATER BOTTLE</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
    <tr>
      <th>4</th>
      <td>536365</td>
      <td>84029E</td>
      <td>RED WOOLLY HOTTIE WHITE HEART.</td>
      <td>6</td>
      <td>2010-12-01 08:26:00</td>
      <td>3.39</td>
      <td>17850.0</td>
      <td>United Kingdom</td>
    </tr>
  </tbody>
</table>
</div>




```python
pur_outlier_treat = pd.merge(outlier_treat,data2, how= 'inner', on='InvoiceNo')
```


```python
pur_outlier_treat.describe()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>n</th>
      <th>Quantity</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>409659.000000</td>
      <td>409659.000000</td>
      <td>409659.000000</td>
      <td>377744.000000</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>44.740753</td>
      <td>9.300894</td>
      <td>3.285169</td>
      <td>15311.610199</td>
    </tr>
    <tr>
      <th>std</th>
      <td>32.773343</td>
      <td>13.535249</td>
      <td>11.628148</td>
      <td>1718.385159</td>
    </tr>
    <tr>
      <th>min</th>
      <td>2.000000</td>
      <td>1.000000</td>
      <td>0.001000</td>
      <td>12347.000000</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>20.000000</td>
      <td>2.000000</td>
      <td>1.250000</td>
      <td>13931.000000</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>35.000000</td>
      <td>4.000000</td>
      <td>1.950000</td>
      <td>15219.000000</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>61.000000</td>
      <td>12.000000</td>
      <td>3.750000</td>
      <td>16813.000000</td>
    </tr>
    <tr>
      <th>max</th>
      <td>150.000000</td>
      <td>100.000000</td>
      <td>3949.320000</td>
      <td>18287.000000</td>
    </tr>
  </tbody>
</table>
</div>




```python
pur_outlier_treat.tail()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>InvoiceNo</th>
      <th>n</th>
      <th>StockCode</th>
      <th>Description</th>
      <th>Quantity</th>
      <th>InvoiceDate</th>
      <th>UnitPrice</th>
      <th>CustomerID</th>
      <th>Country</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>409654</th>
      <td>581587</td>
      <td>15</td>
      <td>22613</td>
      <td>PACK OF 20 SPACEBOY NAPKINS</td>
      <td>12</td>
      <td>2011-12-09 12:50:00</td>
      <td>0.85</td>
      <td>12680.0</td>
      <td>France</td>
    </tr>
    <tr>
      <th>409655</th>
      <td>581587</td>
      <td>15</td>
      <td>22899</td>
      <td>CHILDREN'S APRON DOLLY GIRL</td>
      <td>6</td>
      <td>2011-12-09 12:50:00</td>
      <td>2.10</td>
      <td>12680.0</td>
      <td>France</td>
    </tr>
    <tr>
      <th>409656</th>
      <td>581587</td>
      <td>15</td>
      <td>23254</td>
      <td>CHILDRENS CUTLERY DOLLY GIRL</td>
      <td>4</td>
      <td>2011-12-09 12:50:00</td>
      <td>4.15</td>
      <td>12680.0</td>
      <td>France</td>
    </tr>
    <tr>
      <th>409657</th>
      <td>581587</td>
      <td>15</td>
      <td>23255</td>
      <td>CHILDRENS CUTLERY CIRCUS PARADE</td>
      <td>4</td>
      <td>2011-12-09 12:50:00</td>
      <td>4.15</td>
      <td>12680.0</td>
      <td>France</td>
    </tr>
    <tr>
      <th>409658</th>
      <td>581587</td>
      <td>15</td>
      <td>22138</td>
      <td>BAKING SET 9 PIECE RETROSPOT</td>
      <td>3</td>
      <td>2011-12-09 12:50:00</td>
      <td>4.95</td>
      <td>12680.0</td>
      <td>France</td>
    </tr>
  </tbody>
</table>
</div>




```python
# 국가별로 차이가 있을까?
invoce_product_cnt = pur_outlier_treat.groupby('Country')['InvoiceNo'].nunique().sort_values(ascending = False)
```


```python
invoce_product_cnt = pd.DataFrame(invoce_product_cnt).reset_index()
```


```python
# (코딩연습)
# 각 국가별 가장 많은 거래에 포함된 상품 Top 5 비교 
```


```python

```

##### Method 1) nlargest 이용


```python
t = pd.DataFrame(pur_outlier_treat.groupby(['Country','Description'])['InvoiceNo'].count()).reset_index()
```


```python
t1 = t.groupby('Country').apply(lambda x:x.nlargest(5,'InvoiceNo'))
```


```python
t1 = t1.reset_index(drop = True)
```


```python
t1[t1.Country == 'United Kingdom']
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Country</th>
      <th>Description</th>
      <th>InvoiceNo</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>180</th>
      <td>United Kingdom</td>
      <td>WHITE HANGING HEART T-LIGHT HOLDER</td>
      <td>1942</td>
    </tr>
    <tr>
      <th>181</th>
      <td>United Kingdom</td>
      <td>JUMBO BAG RED RETROSPOT</td>
      <td>1625</td>
    </tr>
    <tr>
      <th>182</th>
      <td>United Kingdom</td>
      <td>REGENCY CAKESTAND 3 TIER</td>
      <td>1493</td>
    </tr>
    <tr>
      <th>183</th>
      <td>United Kingdom</td>
      <td>PARTY BUNTING</td>
      <td>1398</td>
    </tr>
    <tr>
      <th>184</th>
      <td>United Kingdom</td>
      <td>ASSORTED COLOUR BIRD ORNAMENT</td>
      <td>1282</td>
    </tr>
  </tbody>
</table>
</div>




```python
t1.groupby('Country').apply(lambda x: x.sort_values('InvoiceNo')) # 낮은 등급부터 보이기
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>Country</th>
      <th>Description</th>
      <th>InvoiceNo</th>
    </tr>
    <tr>
      <th>Country</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="5" valign="top">Australia</th>
      <th>0</th>
      <td>Australia</td>
      <td>BAKING SET SPACEBOY DESIGN</td>
      <td>8</td>
    </tr>
    <tr>
      <th>1</th>
      <td>Australia</td>
      <td>LUNCH BAG RED RETROSPOT</td>
      <td>8</td>
    </tr>
    <tr>
      <th>2</th>
      <td>Australia</td>
      <td>LUNCH BAG SPACEBOY DESIGN</td>
      <td>8</td>
    </tr>
    <tr>
      <th>3</th>
      <td>Australia</td>
      <td>PARTY BUNTING</td>
      <td>8</td>
    </tr>
    <tr>
      <th>4</th>
      <td>Australia</td>
      <td>ROSES REGENCY TEACUP AND SAUCER</td>
      <td>8</td>
    </tr>
    <tr>
      <th>...</th>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th rowspan="5" valign="top">Unspecified</th>
      <th>186</th>
      <td>Unspecified</td>
      <td>12 PENCILS TALL TUBE RED RETROSPOT</td>
      <td>3</td>
    </tr>
    <tr>
      <th>187</th>
      <td>Unspecified</td>
      <td>4 TRADITIONAL SPINNING TOPS</td>
      <td>3</td>
    </tr>
    <tr>
      <th>188</th>
      <td>Unspecified</td>
      <td>ASSORTED COLOUR BIRD ORNAMENT</td>
      <td>3</td>
    </tr>
    <tr>
      <th>189</th>
      <td>Unspecified</td>
      <td>BINGO SET</td>
      <td>3</td>
    </tr>
    <tr>
      <th>185</th>
      <td>Unspecified</td>
      <td>3 STRIPEY MICE FELTCRAFT</td>
      <td>4</td>
    </tr>
  </tbody>
</table>
<p>190 rows × 3 columns</p>
</div>



##### Method 2) rank 이용


```python
t['rk'] = t.groupby('Country')['InvoiceNo'].rank(method = 'min', ascending = False) #'dense'는 등급별 1씩차이나게
# min 은 1위가 10명이면, 1다음 rank는 11
```


```python
t22 = t[t.rk <= 5]
```


```python
t22  = t22.groupby('Country').apply(lambda x: x.sort_values(by = 'rk'))
```


```python
t22.reset_index(drop = True, inplace = True)
```


```python
pd.merge(invoce_product_cnt, t22, how = 'inner', on = 'Country')
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Country</th>
      <th>InvoiceNo_x</th>
      <th>Description</th>
      <th>InvoiceNo_y</th>
      <th>rk</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>United Kingdom</td>
      <td>15993</td>
      <td>WHITE HANGING HEART T-LIGHT HOLDER</td>
      <td>1942</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>United Kingdom</td>
      <td>15993</td>
      <td>JUMBO BAG RED RETROSPOT</td>
      <td>1625</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>United Kingdom</td>
      <td>15993</td>
      <td>REGENCY CAKESTAND 3 TIER</td>
      <td>1493</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>United Kingdom</td>
      <td>15993</td>
      <td>PARTY BUNTING</td>
      <td>1398</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>United Kingdom</td>
      <td>15993</td>
      <td>ASSORTED COLOUR BIRD ORNAMENT</td>
      <td>1282</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>634</th>
      <td>Saudi Arabia</td>
      <td>1</td>
      <td>GOLD EAR MUFF HEADPHONES</td>
      <td>1</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>635</th>
      <td>Saudi Arabia</td>
      <td>1</td>
      <td>HOMEMADE JAM SCENTED CANDLES</td>
      <td>1</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>636</th>
      <td>Saudi Arabia</td>
      <td>1</td>
      <td>PLASTERS IN TIN CIRCUS PARADE</td>
      <td>1</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>637</th>
      <td>Saudi Arabia</td>
      <td>1</td>
      <td>PLASTERS IN TIN SKULLS</td>
      <td>1</td>
      <td>1.0</td>
    </tr>
    <tr>
      <th>638</th>
      <td>Saudi Arabia</td>
      <td>1</td>
      <td>PLASTERS IN TIN STRONGMAN</td>
      <td>1</td>
      <td>1.0</td>
    </tr>
  </tbody>
</table>
<p>639 rows × 5 columns</p>
</div>



-----------------------------------------------------------------------------------------------

# 데이터 변환 및 데이터 탐색

### 연관성 분석용 matrix생성
: 상품별 구매여부 형태로 만들기  
-  연관성분석(장바구니 분석)시 transactionEncoder 패키지 많이 사용  
- invoiceno별 상품리스트 만들기


```python
pur_by_tran = pur_outlier_treat[['InvoiceNo', 'Description']]
```


```python
hi = pur_by_tran.groupby('InvoiceNo')['Description'].apply(lambda x : list(set(x)))
```


```python
purchcse_list = hi.values
```


```python
te = TransactionEncoder()
```


```python
te_ary = te.fit(purchcse_list).transform(purchcse_list)
```


```python
df = pd.DataFrame(te_ary, columns=te.columns_)
```


```python
df # 대부분의; 셀이 0인 희소행렬(sparse matrix)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>4 PURPLE FLOCK DINNER CANDLES</th>
      <th>50'S CHRISTMAS GIFT BAG LARGE</th>
      <th>DOLLY GIRL BEAKER</th>
      <th>I LOVE LONDON MINI BACKPACK</th>
      <th>I LOVE LONDON MINI RUCKSACK</th>
      <th>NINE DRAWER OFFICE TIDY</th>
      <th>OVAL WALL MIRROR DIAMANTE</th>
      <th>RED SPOT GIFT BAG LARGE</th>
      <th>SET 2 TEA TOWELS I LOVE LONDON</th>
      <th>SPACEBOY BABY GIFT SET</th>
      <th>...</th>
      <th>ZINC STAR T-LIGHT HOLDER</th>
      <th>ZINC SWEETHEART SOAP DISH</th>
      <th>ZINC SWEETHEART WIRE LETTER RACK</th>
      <th>ZINC T-LIGHT HOLDER STAR LARGE</th>
      <th>ZINC T-LIGHT HOLDER STARS LARGE</th>
      <th>ZINC T-LIGHT HOLDER STARS SMALL</th>
      <th>ZINC TOP  2 DOOR WOODEN SHELF</th>
      <th>ZINC WILLIE WINKIE  CANDLE STICK</th>
      <th>ZINC WIRE KITCHEN ORGANISER</th>
      <th>ZINC WIRE SWEETHEART LETTER TRAY</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>...</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>...</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>...</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>...</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>...</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>17778</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>...</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>17779</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>...</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>17780</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>...</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>True</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>17781</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>...</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>17782</th>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>...</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
<p>17783 rows × 3912 columns</p>
</div>



### EDA


```python
pur_outlier_treat['Description'].value_counts().head(10).plot(kind = 'bar')
```




    <AxesSubplot:>




![png](output_77_1.png)



```python
pur_outlier_treat['Description'].value_counts(1).head(10)
```




    WHITE HANGING HEART T-LIGHT HOLDER    0.004965
    REGENCY CAKESTAND 3 TIER              0.004382
    JUMBO BAG RED RETROSPOT               0.004323
    PARTY BUNTING                         0.003637
    LUNCH BAG RED RETROSPOT               0.003437
    ASSORTED COLOUR BIRD ORNAMENT         0.003310
    LUNCH BAG  BLACK SKULL.               0.002900
    SET OF 3 CAKE TINS PANTRY DESIGN      0.002893
    PACK OF 72 RETROSPOT CAKE CASES       0.002641
    LUNCH BAG SPACEBOY DESIGN             0.002609
    Name: Description, dtype: float64




```python
pur_outlier_treat['Description'].value_counts(0).head(10)
```




    WHITE HANGING HEART T-LIGHT HOLDER    2034
    REGENCY CAKESTAND 3 TIER              1795
    JUMBO BAG RED RETROSPOT               1771
    PARTY BUNTING                         1490
    LUNCH BAG RED RETROSPOT               1408
    ASSORTED COLOUR BIRD ORNAMENT         1356
    LUNCH BAG  BLACK SKULL.               1188
    SET OF 3 CAKE TINS PANTRY DESIGN      1185
    PACK OF 72 RETROSPOT CAKE CASES       1082
    LUNCH BAG SPACEBOY DESIGN             1069
    Name: Description, dtype: int64



# 모델링
### 연관성 모델 생성
- 장바구니 분석(컨텐츠 기반 추천(contents-based recommendation))
-  apriori, fpgrowth  



```python
df['WHITE HANGING HEART T-LIGHT HOLDER'].mean()
```




    0.11111735927571276




```python
freq_itemsets1 = fpgrowth(df, min_support = 0.01, max_len = 3, use_colnames = True)
## 지지도 설정은 룰 확인해보면서, 탐색적으로 설정! 보통 0.01~0.05
```


```python
freq_itemsets1
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>support</th>
      <th>itemsets</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>0.111117</td>
      <td>(WHITE HANGING HEART T-LIGHT HOLDER)</td>
    </tr>
    <tr>
      <th>1</th>
      <td>0.021762</td>
      <td>(KNITTED UNION FLAG HOT WATER BOTTLE)</td>
    </tr>
    <tr>
      <th>2</th>
      <td>0.020975</td>
      <td>(RED WOOLLY HOTTIE WHITE HEART.)</td>
    </tr>
    <tr>
      <th>3</th>
      <td>0.017320</td>
      <td>(SET 7 BABUSHKA NESTING BOXES)</td>
    </tr>
    <tr>
      <th>4</th>
      <td>0.014058</td>
      <td>(WHITE METAL LANTERN)</td>
    </tr>
    <tr>
      <th>...</th>
      <td>...</td>
      <td>...</td>
    </tr>
    <tr>
      <th>1196</th>
      <td>0.010178</td>
      <td>(LUNCH BAG SPACEBOY DESIGN , LUNCH BAG VINTAGE...</td>
    </tr>
    <tr>
      <th>1197</th>
      <td>0.010178</td>
      <td>(LUNCH BAG VINTAGE DOILY , LUNCH BAG APPLE DES...</td>
    </tr>
    <tr>
      <th>1198</th>
      <td>0.012146</td>
      <td>(HOT WATER BOTTLE KEEP CALM, LOVE HOT WATER BO...</td>
    </tr>
    <tr>
      <th>1199</th>
      <td>0.014058</td>
      <td>(HOT WATER BOTTLE KEEP CALM, CHOCOLATE HOT WAT...</td>
    </tr>
    <tr>
      <th>1200</th>
      <td>0.011190</td>
      <td>(HAND WARMER RED LOVE HEART, HAND WARMER OWL D...</td>
    </tr>
  </tbody>
</table>
<p>1201 rows × 2 columns</p>
</div>




```python
rules_conf_20 = association_rules(freq_itemsets1, metric = 'confidence', min_threshold= 0.5)
# confidence 해석 : 1이라면, A를 산사람이면 무조건 B도 같이 산다는 의미
```


```python
rules_conf_20.sort_values(by='lift', ascending = False).head(10)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>antecedents</th>
      <th>consequents</th>
      <th>antecedent support</th>
      <th>consequent support</th>
      <th>support</th>
      <th>confidence</th>
      <th>lift</th>
      <th>leverage</th>
      <th>conviction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>434</th>
      <td>(REGENCY TEA PLATE PINK)</td>
      <td>(REGENCY TEA PLATE GREEN , REGENCY TEA PLATE R...</td>
      <td>0.012540</td>
      <td>0.012540</td>
      <td>0.010291</td>
      <td>0.820628</td>
      <td>65.440467</td>
      <td>0.010133</td>
      <td>5.505089</td>
    </tr>
    <tr>
      <th>433</th>
      <td>(REGENCY TEA PLATE GREEN , REGENCY TEA PLATE R...</td>
      <td>(REGENCY TEA PLATE PINK)</td>
      <td>0.012540</td>
      <td>0.012540</td>
      <td>0.010291</td>
      <td>0.820628</td>
      <td>65.440467</td>
      <td>0.010133</td>
      <td>5.505089</td>
    </tr>
    <tr>
      <th>432</th>
      <td>(REGENCY TEA PLATE PINK, REGENCY TEA PLATE ROS...</td>
      <td>(REGENCY TEA PLATE GREEN )</td>
      <td>0.010966</td>
      <td>0.015014</td>
      <td>0.010291</td>
      <td>0.938462</td>
      <td>62.504350</td>
      <td>0.010126</td>
      <td>16.006017</td>
    </tr>
    <tr>
      <th>435</th>
      <td>(REGENCY TEA PLATE GREEN )</td>
      <td>(REGENCY TEA PLATE PINK, REGENCY TEA PLATE ROS...</td>
      <td>0.015014</td>
      <td>0.010966</td>
      <td>0.010291</td>
      <td>0.685393</td>
      <td>62.504350</td>
      <td>0.010126</td>
      <td>3.143717</td>
    </tr>
    <tr>
      <th>427</th>
      <td>(REGENCY TEA PLATE PINK)</td>
      <td>(REGENCY TEA PLATE GREEN )</td>
      <td>0.012540</td>
      <td>0.015014</td>
      <td>0.011247</td>
      <td>0.896861</td>
      <td>59.733629</td>
      <td>0.011058</td>
      <td>9.550078</td>
    </tr>
    <tr>
      <th>428</th>
      <td>(REGENCY TEA PLATE GREEN )</td>
      <td>(REGENCY TEA PLATE PINK)</td>
      <td>0.015014</td>
      <td>0.012540</td>
      <td>0.011247</td>
      <td>0.749064</td>
      <td>59.733629</td>
      <td>0.011058</td>
      <td>3.935102</td>
    </tr>
    <tr>
      <th>436</th>
      <td>(REGENCY TEA PLATE ROSES )</td>
      <td>(REGENCY TEA PLATE PINK, REGENCY TEA PLATE GRE...</td>
      <td>0.018051</td>
      <td>0.011247</td>
      <td>0.010291</td>
      <td>0.570093</td>
      <td>50.689860</td>
      <td>0.010088</td>
      <td>2.299926</td>
    </tr>
    <tr>
      <th>431</th>
      <td>(REGENCY TEA PLATE PINK, REGENCY TEA PLATE GRE...</td>
      <td>(REGENCY TEA PLATE ROSES )</td>
      <td>0.011247</td>
      <td>0.018051</td>
      <td>0.010291</td>
      <td>0.915000</td>
      <td>50.689860</td>
      <td>0.010088</td>
      <td>11.552342</td>
    </tr>
    <tr>
      <th>423</th>
      <td>(REGENCY SUGAR BOWL GREEN)</td>
      <td>(REGENCY MILK JUG PINK )</td>
      <td>0.014958</td>
      <td>0.015296</td>
      <td>0.011584</td>
      <td>0.774436</td>
      <td>50.631607</td>
      <td>0.011355</td>
      <td>4.365523</td>
    </tr>
    <tr>
      <th>424</th>
      <td>(REGENCY MILK JUG PINK )</td>
      <td>(REGENCY SUGAR BOWL GREEN)</td>
      <td>0.015296</td>
      <td>0.014958</td>
      <td>0.011584</td>
      <td>0.757353</td>
      <td>50.631607</td>
      <td>0.011355</td>
      <td>4.059567</td>
    </tr>
  </tbody>
</table>
</div>




```python
freq_itemsets2 = fpgrowth(df, min_support = 0.01, max_len = 2, use_colnames = True)
```


```python
rules_conf_2 = association_rules(freq_itemsets2, metric = 'confidence', min_threshold= 0.5)
```


```python
rules_conf_2.sort_values(by='lift', ascending = False).head(10)
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>antecedents</th>
      <th>consequents</th>
      <th>antecedent support</th>
      <th>consequent support</th>
      <th>support</th>
      <th>confidence</th>
      <th>lift</th>
      <th>leverage</th>
      <th>conviction</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>162</th>
      <td>(REGENCY TEA PLATE GREEN )</td>
      <td>(REGENCY TEA PLATE PINK)</td>
      <td>0.015014</td>
      <td>0.012540</td>
      <td>0.011247</td>
      <td>0.749064</td>
      <td>59.733629</td>
      <td>0.011058</td>
      <td>3.935102</td>
    </tr>
    <tr>
      <th>161</th>
      <td>(REGENCY TEA PLATE PINK)</td>
      <td>(REGENCY TEA PLATE GREEN )</td>
      <td>0.012540</td>
      <td>0.015014</td>
      <td>0.011247</td>
      <td>0.896861</td>
      <td>59.733629</td>
      <td>0.011058</td>
      <td>9.550078</td>
    </tr>
    <tr>
      <th>157</th>
      <td>(REGENCY SUGAR BOWL GREEN)</td>
      <td>(REGENCY MILK JUG PINK )</td>
      <td>0.014958</td>
      <td>0.015296</td>
      <td>0.011584</td>
      <td>0.774436</td>
      <td>50.631607</td>
      <td>0.011355</td>
      <td>4.365523</td>
    </tr>
    <tr>
      <th>158</th>
      <td>(REGENCY MILK JUG PINK )</td>
      <td>(REGENCY SUGAR BOWL GREEN)</td>
      <td>0.015296</td>
      <td>0.014958</td>
      <td>0.011584</td>
      <td>0.757353</td>
      <td>50.631607</td>
      <td>0.011355</td>
      <td>4.059567</td>
    </tr>
    <tr>
      <th>164</th>
      <td>(REGENCY TEA PLATE ROSES )</td>
      <td>(REGENCY TEA PLATE PINK)</td>
      <td>0.018051</td>
      <td>0.012540</td>
      <td>0.010966</td>
      <td>0.607477</td>
      <td>48.442857</td>
      <td>0.010739</td>
      <td>2.515672</td>
    </tr>
    <tr>
      <th>163</th>
      <td>(REGENCY TEA PLATE PINK)</td>
      <td>(REGENCY TEA PLATE ROSES )</td>
      <td>0.012540</td>
      <td>0.018051</td>
      <td>0.010966</td>
      <td>0.874439</td>
      <td>48.442857</td>
      <td>0.010739</td>
      <td>7.820523</td>
    </tr>
    <tr>
      <th>156</th>
      <td>(REGENCY TEA PLATE ROSES )</td>
      <td>(REGENCY TEA PLATE GREEN )</td>
      <td>0.018051</td>
      <td>0.015014</td>
      <td>0.012540</td>
      <td>0.694704</td>
      <td>46.269371</td>
      <td>0.012269</td>
      <td>3.226331</td>
    </tr>
    <tr>
      <th>155</th>
      <td>(REGENCY TEA PLATE GREEN )</td>
      <td>(REGENCY TEA PLATE ROSES )</td>
      <td>0.015014</td>
      <td>0.018051</td>
      <td>0.012540</td>
      <td>0.835206</td>
      <td>46.269371</td>
      <td>0.012269</td>
      <td>5.958645</td>
    </tr>
    <tr>
      <th>109</th>
      <td>(PINK  POLKADOT CUP)</td>
      <td>(BLUE POLKADOT CUP)</td>
      <td>0.014902</td>
      <td>0.016027</td>
      <td>0.010572</td>
      <td>0.709434</td>
      <td>44.266190</td>
      <td>0.010333</td>
      <td>3.386402</td>
    </tr>
    <tr>
      <th>110</th>
      <td>(BLUE POLKADOT CUP)</td>
      <td>(PINK  POLKADOT CUP)</td>
      <td>0.016027</td>
      <td>0.014902</td>
      <td>0.010572</td>
      <td>0.659649</td>
      <td>44.266190</td>
      <td>0.010333</td>
      <td>2.894360</td>
    </tr>
  </tbody>
</table>
</div>


